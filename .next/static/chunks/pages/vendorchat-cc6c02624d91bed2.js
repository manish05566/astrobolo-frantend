(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[416],{5438:(e,t,a)=>{"use strict";a.d(t,{A:()=>u});var s=a(7876),r=a(4232),n=a(8230),l=a.n(n),o=a(6460),i=a(8581),c=a(9099);let d=function(){let[e,t]=(0,r.useState)(null),[a,n]=(0,r.useState)(null),[l,c]=(0,r.useState)(""),[d,u]=(0,r.useState)(""),[m,h]=(0,r.useState)("/images/userprofile.png"),[p,g]=(0,r.useState)(null);(0,r.useEffect)(()=>{let e=localStorage.getItem("user");if(e){let t=JSON.parse(e),a=null==t?void 0:t.user,s=null==t?void 0:t.type;(null==a?void 0:a.id)&&"vendor"===s?(g(a.id),f(a.id)):console.warn("User type is not 'user' or ID is missing")}},[]);let f=async e=>{let a=localStorage.getItem("token");if(!e||!a)return void console.warn("Missing ID or token");try{let s=await (0,i.W)("".concat(o.v.base_url,"vendors/").concat(e),{method:"GET",headers:{Authorization:"Bearer ".concat(a)}});if(!s.ok)throw Error("HTTP error! status: ".concat(s.status));let r=await s.json();if(s.ok&&r.data){let e=r.data.image||"/images/userprofile.png";h(e),t(r.data)}}catch(e){console.error("Error fetching user:",e)}},v=async()=>{if(!a||!p)return;let e=new FormData;e.append("image",a);try{let t=localStorage.getItem("token"),a=await (0,i.W)("".concat(o.v.base_url,"vendors/upload-profile/").concat(p),{method:"PUT",headers:{Authorization:"Bearer ".concat(t)},body:e}),s=await a.json();if(a.ok&&s.status){let e=s.data||"/images/userprofile.png";h("".concat(e,"?").concat(Date.now())),n(null)}else c(s.message||"Upload failed. Try again."),u("error")}catch(e){console.error("Upload error:",e),alert("Something went wrong while uploading.")}};return(0,s.jsxs)("div",{className:"text-center user-photo",children:[(0,s.jsxs)("div",{className:"position-relative d-inline-block",children:[(0,s.jsx)("img",{src:m,className:"rounded-circle profile-pic img-thumbnail",alt:"Profile",width:"120",height:"120"}),(0,s.jsx)("label",{htmlFor:"upload-photo",className:"btn btn-primary btn-sm position-absolute bottom-0 end-0 rounded-circle",title:"Change Photo",style:{cursor:"pointer"},children:(0,s.jsx)("i",{className:"fas fa-camera"})}),(0,s.jsx)("input",{type:"file",id:"upload-photo",accept:"image/*",onChange:e=>{var t;let a=null==(t=e.target.files)?void 0:t[0];if(a){if(a.size/1024>50){c("Image size should be 50KB or less."),u("error"),n(null);return}c(""),u(""),n(a),h(URL.createObjectURL(a))}},style:{display:"none"}})]}),(0,s.jsxs)("div",{className:"mt-2",children:[l&&(0,s.jsx)("p",{style:{color:"success"===d?"green":"red",fontSize:"0.75rem",margin:0},children:l}),!l&&a&&(0,s.jsx)("button",{className:"btn btn-success btn-sm",style:{fontSize:"0.75rem",padding:"2px 8px"},onClick:()=>v(a),children:"Upload"})]}),(0,s.jsxs)("p",{className:"mt-2 mb-1 profile-name fw-bold",children:[null==e?void 0:e.first_name," ",null==e?void 0:e.last_name]}),(0,s.jsxs)("p",{className:"text-muted mb-3 profile-number",children:["(+91 ",null==e?void 0:e.mobile,")"]})]})},u=function(){let e=(0,c.useRouter)();e.pathname;let[t,a]=(0,r.useState)(0),n=async()=>{var t,s;let r=localStorage.getItem("token"),n=JSON.parse(localStorage.getItem("user")),l=null==n||null==(t=n.user)?void 0:t.id;if(l&&"/vendorchat"!==e.pathname){if("true"===sessionStorage.getItem("resetUnread"))return void sessionStorage.removeItem("resetUnread");try{let e=await (0,i.W)("".concat(o.v.base_url,"chat/unread-count/").concat(l),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r)}}),t=await e.json();"number"==typeof(null==t||null==(s=t.data)?void 0:s.unreadCount)?(a(t.data.unreadCount),Array.isArray(t.data.customerIds)&&t.data.customerIds.length>0&&sessionStorage.setItem("latestCustomerId",t.data.customerIds[0])):console.warn("Unexpected unread count structure:",null==t?void 0:t.data)}catch(e){console.error("Failed to fetch unread count",e)}}};return(0,r.useEffect)(()=>{if("/vendorchat"===e.pathname)return void a(0);n();let t=setInterval(()=>{n()},5e3);return()=>clearInterval(t)},[e.pathname]),(0,s.jsx)("div",{className:"p-4 pt-0 Sidebar",children:(0,s.jsxs)("div",{className:"nav flex-column nav-pills leftbar",children:[(0,s.jsx)("div",{className:"profile-ph-part",children:(0,s.jsx)(d,{})}),(0,s.jsxs)("div",{className:"left-menu py-3",children:[(0,s.jsx)(l(),{href:"vendor",className:"nav-link border-bottom",children:"Personal Info"}),(0,s.jsx)(l(),{href:"/astrologerTransaction",className:"nav-link border-bottom",children:"Transaction"}),(0,s.jsx)(l(),{href:"/vendorupload",className:"nav-link border-bottom",children:"Upload Documents"}),(0,s.jsxs)(l(),{href:"/vendor-requests",className:"nav-link border-bottom d-flex justify-content-between align-items-center",children:["Notifications ",(0,s.jsx)("span",{children:t})]})]})]})})}},5464:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>g});var s=a(7876);a(8230);var r=a(4232),n=a(7163),l=a(26),o=a(9099),i=a(6143);a(2491);var c=a(6460),d=a(8581);let u=function(e){let{data:t}=e,a=(0,o.useRouter)(),{messages:u,input:m,setInput:h,sendMessage:p,formatTime:g,remainingTime:f}=(0,i.A)(t,"astrologer"),v=(0,r.useRef)(null),x=a.query.customerImage||"/images/userprofile.png";(0,r.useEffect)(()=>{if(window.socket)return window.socket.on("chat_ended_by_customer",e=>{console.log("âœ… Chat ended. Ready for next request.",e)}),()=>{window.socket.off("chat_ended_by_customer")}},[]),(0,r.useEffect)(()=>{var e;null==(e=v.current)||e.scrollIntoView({behavior:"smooth"})},[u]),(0,r.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("token");(null==t?void 0:t.id)&&e&&(await (0,d.W)("".concat(c.v.base_url,"chat/mark-read/").concat(t.id),{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)}}),sessionStorage.removeItem("fromNotif"))}catch(e){console.error("Failed to mark messages as read",e)}})()},[t]);let j="customer";if(u.length){var b;let e=u.find(e=>!e.isSent);(null==e||null==(b=e.message)?void 0:b.startsWith("Hi, I am "))&&(j=e.message.split("\n")[0].replace("Hi, I am ",""))}return(0,s.jsx)("div",{className:"chat-bg",children:(0,s.jsx)("div",{className:"container py-4",children:(0,s.jsx)("div",{className:"row justify-content-center",children:(0,s.jsxs)("div",{className:"col-lg-9",children:[(0,s.jsx)("div",{className:"chat-header d-flex align-items-center justify-content-between",children:(0,s.jsxs)("div",{className:"d-flex align-items-center",children:[(0,s.jsx)("img",{src:x,alt:"avatar",className:"rounded-circle border border-2 border-dark p-1",style:{width:"32px",height:"32px",objectFit:"cover"}}),(0,s.jsxs)("div",{className:"user-info ms-2",children:[(0,s.jsx)("h6",{className:"mb-0",children:j}),(0,s.jsxs)("small",{children:["Balance: (",g(f)," mins)"]}),(0,s.jsx)("br",{}),(0,s.jsx)("small",{children:"Chat in progress."})]})]})}),(0,s.jsx)("div",{className:"chat-body",children:(0,s.jsxs)("div",{className:"d-flex flex-column",children:[u.map((e,t)=>(0,s.jsxs)("div",{className:"mb-2 p-2 ".concat(e.isSent?"chat-message align-self-end":"chat-message-left align-self-start"," rounded"),children:[e.isImage?(0,s.jsx)("img",{src:e.message,alt:"sent",style:{maxWidth:"200px",borderRadius:"10px"}}):(0,s.jsx)("p",{className:"mb-0",children:e.message}),(0,s.jsx)("small",{className:"d-block text-muted text-end text-offwhite",children:e.time})]},t)),(0,s.jsx)("div",{ref:v})]})}),(0,s.jsx)("div",{className:"chat-footer",children:(0,s.jsxs)("div",{className:"input-group",children:[(0,s.jsx)("span",{className:"input-group-text",children:(0,s.jsx)(n.A,{className:"icon"})}),(0,s.jsx)("input",{type:"text",className:"form-control",placeholder:"Type a message...",value:m,onChange:e=>h(e.target.value),onKeyDown:e=>"Enter"===e.key&&p()}),(0,s.jsx)("button",{className:"btn btn-primary",onClick:p,children:(0,s.jsx)(l.A,{className:"icon"})})]})})]})})})})};var m=a(5438),h=a(432),p=a(3276);function g(){let{id:e}=(0,o.useRouter)().query,[t,a]=(0,r.useState)(null),[n,l]=(0,r.useState)(!0);return(0,r.useEffect)(()=>{let e=localStorage.getItem("token"),t=JSON.parse(localStorage.getItem("user")),s=null==t?void 0:t.user.id,r=null==t?void 0:t.type;if(!s||!r)return void console.error("Missing AstrologerId or astrologerType");!(!e||(0,p.H)(e))&&"vendor"===r&&s&&(0,d.W)("".concat(c.v.base_url,"vendors/").concat(s)).then(e=>e.json()).then(e=>{let t=null==e?void 0:e.data;t&&a({id:t.id,first_name:t.first_name,chat_charge:t.chat_charge,image:t.image||"/images/userprofile.png"})}).catch(e=>console.error("Error fetching detail",e)).finally(()=>l(!1))},[e]),(0,h.A)(),(0,s.jsx)("div",{className:"bg-light sectiontop-margin",children:(0,s.jsx)("div",{className:"container-fluid pb-5 pt-0",children:(0,s.jsx)("div",{className:"row",children:(0,s.jsx)("div",{className:"col-12",children:(0,s.jsx)("div",{className:"card border-0 shadow-sm",children:(0,s.jsx)("div",{className:"card-body p-0",children:(0,s.jsxs)("div",{className:"row g-0",children:[(0,s.jsx)("div",{className:"col-lg-3 border-end",children:(0,s.jsx)(m.A,{})}),(0,s.jsx)("div",{className:"col-lg-9",children:(0,s.jsx)(u,{data:t})})]})})})})})})})}},6458:(e,t,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/vendorchat",function(){return a(5464)}])}},e=>{e.O(0,[692,491,679,636,593,792],()=>e(e.s=6458)),_N_E=e.O()}]);