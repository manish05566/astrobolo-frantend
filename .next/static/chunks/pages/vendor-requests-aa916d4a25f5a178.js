(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[573],{2445:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>d});var o=s(7876),r=s(4232),a=s(5438),n=s(6460),c=s(8581),l=s(9099),i=s(7431);let d=function(){let[e,t]=(0,r.useState)([]),s=(0,l.useRouter)();return(0,r.useEffect)(()=>{var e;let s=JSON.parse(localStorage.getItem("user")),o=null==s||null==(e=s.user)?void 0:e.id;if(!o)return;(0,i.b0)(o,"");let r=(0,i.mb)(e=>{t(t=>t.some(t=>t.roomId===e.roomId)||t.length>=5?t:[...t,{customerId:e.senderId,name:e.customerName||"Customer #".concat(e.senderId),message:"You have a new request",roomId:e.roomId,receiverId:e.receiverId,senderId:e.senderId,customerImage:e.customerImage}]),console.log("")});return()=>{null==r||r()}},[]),(0,r.useEffect)(()=>{(async()=>{var e,s;let o=localStorage.getItem("token"),r=localStorage.getItem("user"),a=r?JSON.parse(r):null,l=null==a||null==(e=a.user)?void 0:e.id;if(l&&o)try{let e=await (0,c.W)("".concat(n.v.base_url,"chat/unread-count/").concat(l),{headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"}}),r=null==(s=(await e.json()).data)?void 0:s.customerIds;if(!Array.isArray(r)||0===r.length)return void t([]);let a=await Promise.all(r.map(async e=>{try{let t=await (0,c.W)("".concat(n.v.base_url,"users/").concat(e),{headers:{Authorization:"Bearer ".concat(o)}}),s=(await t.json()).data||{};return{customerId:e,name:s.first_name||"Customer #".concat(e),customerImage:s.image||"/images/default-user.png",message:"You have a new request",roomId:"".concat(e,"-").concat(l),receiverId:l,senderId:e}}catch(t){return{customerId:e,name:"Customer #".concat(e),customerImage:"/images/default-user.png",message:"You have a new request",roomId:"".concat(e,"-").concat(l),receiverId:l,senderId:e}}}));t(a)}catch(e){console.error("Failed to fetch requests",e)}})()},[]),(0,o.jsx)("div",{className:"bg-light sectiontop-margin",children:(0,o.jsx)("div",{className:"container-fluid pb-5 pt-0",children:(0,o.jsx)("div",{className:"row",children:(0,o.jsx)("div",{className:"col-12",children:(0,o.jsx)("div",{className:"card border-0 shadow-sm",children:(0,o.jsx)("div",{className:"card-body p-0",children:(0,o.jsxs)("div",{className:"row g-0",children:[(0,o.jsx)("div",{className:"col-lg-3 border-end",children:(0,o.jsx)(a.A,{})}),(0,o.jsxs)("div",{className:"col-lg-9 p-4",children:[(0,o.jsx)("h4",{className:"mb-4",children:"Customer Requests"}),0===e.length?(0,o.jsx)("p",{children:"No pending requests right now."}):(0,o.jsx)("div",{className:"row",children:e.map(e=>(0,o.jsx)("div",{className:"col-md-3 mb-3",children:(0,o.jsxs)("div",{className:"card d-flex flex-row align-items-center p-2",children:[(0,o.jsxs)("div",{className:"waiting-img text-center",children:[(0,o.jsx)("img",{src:e.customerImage||"/images/userprofile.png",className:"rounded-circle img-thumbnail",alt:"Profile",width:"40",height:"40"}),(0,o.jsx)("span",{className:"badge bg-secondary mt-1",children:"Chat"})]}),(0,o.jsxs)("div",{className:"flex-grow-1 ms-2",children:[(0,o.jsx)("div",{className:"fw-bold",children:e.name}),(0,o.jsx)("div",{className:"text-muted",children:e.message})]}),(0,o.jsx)("button",{className:"btn btn-outline-success btn-sm ms-2",onClick:()=>{var o,r;window.socket.emit("accept_chat",{senderId:e.senderId,receiverId:e.receiverId,roomId:e.roomId}),t(t=>t.filter(t=>t.roomId!==e.roomId)),o=e.customerId,r=e.customerImage,s.push({pathname:"/vendorchat",query:{customerId:o,customerImage:r}})},children:"Accept"})]})},e.roomId))})]})]})})})})})})})}},5438:(e,t,s)=>{"use strict";s.d(t,{A:()=>u});var o=s(7876),r=s(4232),a=s(8230),n=s.n(a),c=s(6460),l=s(8581),i=s(9099);let d=function(){let[e,t]=(0,r.useState)(null),[s,a]=(0,r.useState)(null),[n,i]=(0,r.useState)(""),[d,u]=(0,r.useState)(""),[m,h]=(0,r.useState)("/images/userprofile.png"),[g,p]=(0,r.useState)(null);(0,r.useEffect)(()=>{let e=localStorage.getItem("user");if(e){let t=JSON.parse(e),s=null==t?void 0:t.user,o=null==t?void 0:t.type;(null==s?void 0:s.id)&&"vendor"===o?(p(s.id),v(s.id)):console.warn("User type is not 'user' or ID is missing")}},[]);let v=async e=>{let s=localStorage.getItem("token");if(!e||!s)return void console.warn("Missing ID or token");try{let o=await (0,l.W)("".concat(c.v.base_url,"vendors/").concat(e),{method:"GET",headers:{Authorization:"Bearer ".concat(s)}});if(!o.ok)throw Error("HTTP error! status: ".concat(o.status));let r=await o.json();if(o.ok&&r.data){let e=r.data.image||"/images/userprofile.png";h(e),t(r.data)}}catch(e){console.error("Error fetching user:",e)}},f=async()=>{if(!s||!g)return;let e=new FormData;e.append("image",s);try{let t=localStorage.getItem("token"),s=await (0,l.W)("".concat(c.v.base_url,"vendors/upload-profile/").concat(g),{method:"PUT",headers:{Authorization:"Bearer ".concat(t)},body:e}),o=await s.json();if(s.ok&&o.status){let e=o.data||"/images/userprofile.png";h("".concat(e,"?").concat(Date.now())),a(null)}else i(o.message||"Upload failed. Try again."),u("error")}catch(e){console.error("Upload error:",e),alert("Something went wrong while uploading.")}};return(0,o.jsxs)("div",{className:"text-center user-photo",children:[(0,o.jsxs)("div",{className:"position-relative d-inline-block",children:[(0,o.jsx)("img",{src:m,className:"rounded-circle profile-pic img-thumbnail",alt:"Profile",width:"120",height:"120"}),(0,o.jsx)("label",{htmlFor:"upload-photo",className:"btn btn-primary btn-sm position-absolute bottom-0 end-0 rounded-circle",title:"Change Photo",style:{cursor:"pointer"},children:(0,o.jsx)("i",{className:"fas fa-camera"})}),(0,o.jsx)("input",{type:"file",id:"upload-photo",accept:"image/*",onChange:e=>{var t;let s=null==(t=e.target.files)?void 0:t[0];if(s){if(s.size/1024>50){i("Image size should be 50KB or less."),u("error"),a(null);return}i(""),u(""),a(s),h(URL.createObjectURL(s))}},style:{display:"none"}})]}),(0,o.jsxs)("div",{className:"mt-2",children:[n&&(0,o.jsx)("p",{style:{color:"success"===d?"green":"red",fontSize:"0.75rem",margin:0},children:n}),!n&&s&&(0,o.jsx)("button",{className:"btn btn-success btn-sm",style:{fontSize:"0.75rem",padding:"2px 8px"},onClick:()=>f(s),children:"Upload"})]}),(0,o.jsxs)("p",{className:"mt-2 mb-1 profile-name fw-bold",children:[null==e?void 0:e.first_name," ",null==e?void 0:e.last_name]}),(0,o.jsxs)("p",{className:"text-muted mb-3 profile-number",children:["(+91 ",null==e?void 0:e.mobile,")"]})]})},u=function(){let e=(0,i.useRouter)();e.pathname;let[t,s]=(0,r.useState)(0),a=async()=>{var t,o;let r=localStorage.getItem("token"),a=JSON.parse(localStorage.getItem("user")),n=null==a||null==(t=a.user)?void 0:t.id;if(n&&"/vendorchat"!==e.pathname){if("true"===sessionStorage.getItem("resetUnread"))return void sessionStorage.removeItem("resetUnread");try{let e=await (0,l.W)("".concat(c.v.base_url,"chat/unread-count/").concat(n),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r)}}),t=await e.json();"number"==typeof(null==t||null==(o=t.data)?void 0:o.unreadCount)?(s(t.data.unreadCount),Array.isArray(t.data.customerIds)&&t.data.customerIds.length>0&&sessionStorage.setItem("latestCustomerId",t.data.customerIds[0])):console.warn("Unexpected unread count structure:",null==t?void 0:t.data)}catch(e){console.error("Failed to fetch unread count",e)}}};return(0,r.useEffect)(()=>{if("/vendorchat"===e.pathname)return void s(0);a();let t=setInterval(()=>{a()},5e3);return()=>clearInterval(t)},[e.pathname]),(0,o.jsx)("div",{className:"p-4 pt-0 Sidebar",children:(0,o.jsxs)("div",{className:"nav flex-column nav-pills leftbar",children:[(0,o.jsx)("div",{className:"profile-ph-part",children:(0,o.jsx)(d,{})}),(0,o.jsxs)("div",{className:"left-menu py-3",children:[(0,o.jsx)(n(),{href:"vendor",className:"nav-link border-bottom",children:"Personal Info"}),(0,o.jsx)(n(),{href:"/astrologerTransaction",className:"nav-link border-bottom",children:"Transaction"}),(0,o.jsx)(n(),{href:"/vendorupload",className:"nav-link border-bottom",children:"Upload Documents"}),(0,o.jsxs)(n(),{href:"/vendor-requests",className:"nav-link border-bottom d-flex justify-content-between align-items-center",children:["Notifications ",(0,o.jsx)("span",{children:t})]})]})]})})}},7431:(e,t,s)=>{"use strict";s.d(t,{$d:()=>a,G1:()=>u,SR:()=>l,_z:()=>c,b0:()=>n,mb:()=>i,pY:()=>d});var o=s(2692);let r=null,a=(e,t)=>[e,t].sort().join("-"),n=(e,t)=>{let s=a(e,t);return console.log("\uD83D\uDFE1 [initiateSocket] userId:",e,"receiverId:",t,"roomId:",s),new Promise(t=>{r||(r=(0,o.io)("http://localhost:4000",{transports:["websocket"],query:{userId:e},withCredentials:!0}),window.socket=r),r.on("connect",()=>{console.log("✅ [Socket Connected] ID:",r.id),r.emit("join_room",s),console.log("\uD83D\uDCE9 [Join Room] roomId:",s),t(r)}),r.on("disconnect",()=>{console.log("\uD83D\uDD34 [Socket Disconnected]")})})},c=e=>{if(!r)return void console.log("❌ [sendMessage] Socket not initialized.");let t=a(e.sender_id,e.receiver_id);console.log("\uD83D\uDCE4 [sendMessage] Emitting to room:",t,"Message:",e),r.emit("sendMessage",{message:e,roomId:t})},l=e=>{if(!r)return;let t=t=>{console.log("\uD83D\uDCEC [subscribeToMessages] Received message:",t),e(t)};return r.on("receiveMessage",t),()=>{r.off("receiveMessage",t)}},i=e=>{if(!r)return;let t=t=>{console.log("\uD83D\uDCE8 [subscribeToChatRequests] Incoming:",t),e(t)};return r.on("request_chat",t),()=>{r.off("request_chat",t)}},d=e=>{if(console.log(" under subscribeToChatAccepted function in socket"),!r)return;let t=t=>{console.log("✅ [subscribeToChatAccepted] Chat accepted by astrologer:",t),e(t)};return r.on("chat_accepted",t),console.log("socket chat accepted 1"),()=>{console.log("socket chat accepted 2"),r.off("chat_accepted",t)}},u=()=>{r&&(console.log("\uD83D\uDD0C [disconnectSocket] Disconnecting..."),r.disconnect(),r=null)}},9122:(e,t,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/vendor-requests",function(){return s(2445)}])}},e=>{e.O(0,[692,636,593,792],()=>e(e.s=9122)),_N_E=e.O()}]);