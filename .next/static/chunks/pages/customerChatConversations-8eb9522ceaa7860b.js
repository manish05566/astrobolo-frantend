(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[286],{7079:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>m});var a=s(7876),l=s(9099),i=s(4232),o=s(6460),n=s(7431),r=s(2491),c=s.n(r),d=s(8581);let m=function(){let e=(0,l.useRouter)(),{userId:t,astrologerId:s}=e.query,[r,m]=(0,i.useState)([]),[u,h]=(0,i.useState)(!1),[g,p]=(0,i.useState)(null),[x,b]=(0,i.useState)(""),[f,v]=(0,i.useState)(""),j="/images/userprofile.png";return(0,i.useEffect)(()=>{(async()=>{let e=localStorage.getItem("token"),{type:a,user:l}=JSON.parse(localStorage.getItem("user"));if(l&&b(l.name),t&&s&&e)try{let a=await (0,d.W)("".concat(o.v.base_url,"chat/conversations?userId=").concat(t,"&astrologerId=").concat(s),{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}}),l=await a.json(),i=null==l?void 0:l.data;if(console.log("chatData",i),!i||!Array.isArray(i))return;let n=i.map(e=>({text:e.message,time:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),isSent:e.sender_id===t,isImage:"image"===e.message_type||/\.(jpeg|jpg|gif|png|webp)$/i.test(e.message)}));m(n),v(i.chat_transaction);let r=i.find(e=>e.astrologer);(null==r?void 0:r.astrologer)&&p(r.astrologer)}catch(e){console.error("Error fetching chat detail",e)}})()},[t,s]),(0,a.jsxs)("div",{className:"chat-bg",onDragOver:e=>{e.preventDefault(),h(!0)},onDragLeave:()=>h(!1),onDrop:e=>{e.preventDefault(),h(!1),Array.from(e.dataTransfer.files).forEach(e=>{if(e.type.startsWith("image/")){let t=new FileReader;t.onloadend=()=>{m(e=>[...e,{text:t.result,time:(()=>{let e=new Date,t=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0");return"".concat(t,":").concat(s)})(),isSent:!0,isImage:!0}])},t.readAsDataURL(e)}})},style:{position:"relative"},children:[u&&(0,a.jsx)("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.3)",zIndex:10,display:"flex",justifyContent:"center",alignItems:"center",color:"#fff",fontSize:"1.5rem"},children:"Drop image here to send"}),(0,a.jsx)("div",{className:"container ",style:{marginTop:"130px"},children:(0,a.jsxs)("ul",{className:"nav nav-pills nav-justified mb-4",id:"Chathistory",role:"tablist",children:[(0,a.jsx)("li",{className:"nav-item",role:"presentation",children:(0,a.jsx)("button",{className:"nav-link active",id:"pills-chat-tab","data-bs-toggle":"pill","data-bs-target":"#pills-chat",type:"button",role:"tab","aria-controls":"pills-chat","aria-selected":"false",children:"Chat"})}),(0,a.jsx)("li",{className:"nav-item",role:"presentation",children:(0,a.jsx)("button",{className:"nav-link ",id:"pills-call-tab","data-bs-toggle":"pill","data-bs-target":"#pills-call",type:"button",role:"tab","aria-controls":"pills-call","aria-selected":"true",children:"Call"})})]})}),(0,a.jsx)("div",{className:"container ",children:(0,a.jsx)("div",{className:"row justify-content-center",children:(0,a.jsxs)("div",{className:"col-lg-9",children:[(0,a.jsx)("div",{className:"chat-header d-flex align-items-center justify-content-between",children:(0,a.jsxs)("div",{className:"d-flex align-items-center",children:[(0,a.jsx)("img",{src:(null==g?void 0:g.image)||j,alt:"avatar",className:"rounded-circle border border-2 border-dark p-1",style:{width:"32px",height:"32px",objectFit:"cover"}}),(0,a.jsxs)("div",{className:"user-info ms-2",children:[(0,a.jsx)("h6",{className:"mb-0",children:(null==g?void 0:g.first_name)||"Astro Name"}),(0,a.jsx)("small",{children:"Chat has ended"})]})]})}),(0,a.jsxs)("div",{className:"chat-body chat-body-history d-flex flex-column",children:[(0,a.jsx)("div",{className:"d-flex flex-column flex-grow-1 mb-3",children:r.map((e,t)=>(0,a.jsxs)("div",{className:"position-relative mb-2 p-2 shadow-sm rounded ".concat(e.isSent?"chat-bubble-sent":"chat-bubble-received"),children:[e.isImage?(0,a.jsx)("img",{src:e.text,alt:"sent-img",style:{maxWidth:"200px",borderRadius:"10px"}}):(0,a.jsx)("p",{className:"mb-1",children:e.text}),(0,a.jsx)("small",{className:"d-block text-end text-muted",children:e.time})]},t))}),(0,a.jsxs)("div",{className:"chat-card p-3 bg-white rounded shadow-sm",style:{margin:"auto",maxWidth:"480px",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.06)"},children:[(0,a.jsxs)("div",{className:"d-flex align-items-center",children:[(0,a.jsxs)("div",{className:"me-3 text-center",children:[(0,a.jsx)("img",{src:(null==g?void 0:g.image)||j,alt:"Profile",className:"rounded-circle",style:{width:"40px",height:"40px",objectFit:"cover"}}),(0,a.jsx)("p",{className:"text-dark mb-0 mt-1",children:"★ 5"}),(0,a.jsx)("small",{className:"text-muted",children:(null==g?void 0:g.first_name)||"Kritishanti"})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("p",{className:"mb-0",style:{fontSize:"15px"},children:["Hi ",x,", let's continue this chat at price of ₹",(null==g?void 0:g.total_charge)||20," / min"]}),(0,a.jsx)("small",{className:"text-muted",children:"Celebrity Astrologer"})]})]}),(0,a.jsx)("div",{className:"d-flex justify-content-center mt-3",children:(0,a.jsx)("button",{className:"btn text-white",style:{backgroundColor:"#81689D",borderRadius:"6px",fontWeight:500,padding:"6px 20px"},onClick:()=>{var t;let s=JSON.parse(localStorage.getItem("user")||"{}"),a=(null==s?void 0:s.id)||(null==s||null==(t=s.user)?void 0:t.id);if(!a)return void c().fire("Please log in first","","warning");localStorage.setItem("selected_consultants",JSON.stringify([g])),(0,n.b0)(a,g.id);let l=(0,n.$d)(a,g.id);window.socket.emit("request_chat",{senderId:a,receiverId:g.id,roomId:l}),e.push("/astrologer")},children:"Continue Chat"})})]})]})]})})})]})}},7431:(e,t,s)=>{"use strict";s.d(t,{$d:()=>i,G1:()=>m,SR:()=>r,_z:()=>n,b0:()=>o,mb:()=>c,pY:()=>d});var a=s(2692);let l=null,i=(e,t)=>[e,t].sort().join("-"),o=(e,t)=>{let s=i(e,t);return console.log("\uD83D\uDFE1 [initiateSocket] userId:",e,"receiverId:",t,"roomId:",s),new Promise(t=>{l||(l=(0,a.io)("http://www.astrobolo.com",{transports:["websocket"],query:{userId:e},withCredentials:!0}),window.socket=l),l.on("connect",()=>{console.log("✅ [Socket Connected] ID:",l.id),l.emit("join_room",s),console.log("\uD83D\uDCE9 [Join Room] roomId:",s),t(l)}),l.on("disconnect",()=>{console.log("\uD83D\uDD34 [Socket Disconnected]")})})},n=e=>{if(!l)return void console.log("❌ [sendMessage] Socket not initialized.");let t=i(e.sender_id,e.receiver_id);console.log("\uD83D\uDCE4 [sendMessage] Emitting to room:",t,"Message:",e),l.emit("sendMessage",{message:e,roomId:t})},r=e=>{if(!l)return;let t=t=>{console.log("\uD83D\uDCEC [subscribeToMessages] Received message:",t),e(t)};return l.on("receiveMessage",t),()=>{l.off("receiveMessage",t)}},c=e=>{if(!l)return;let t=t=>{console.log("\uD83D\uDCE8 [subscribeToChatRequests] Incoming:",t),e(t)};return l.on("request_chat",t),()=>{l.off("request_chat",t)}},d=e=>{if(console.log(" under subscribeToChatAccepted function in socket"),!l)return;let t=t=>{console.log("✅ [subscribeToChatAccepted] Chat accepted by astrologer:",t),e(t)};return l.on("chat_accepted",t),console.log("socket chat accepted 1"),()=>{console.log("socket chat accepted 2"),l.off("chat_accepted",t)}},m=()=>{l&&(console.log("\uD83D\uDD0C [disconnectSocket] Disconnecting..."),l.disconnect(),l=null)}},8975:(e,t,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/customerChatConversations",function(){return s(7079)}])}},e=>{e.O(0,[692,491,636,593,792],()=>e(e.s=8975)),_N_E=e.O()}]);