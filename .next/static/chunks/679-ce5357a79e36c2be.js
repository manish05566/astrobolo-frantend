"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[679],{26:(e,t,o)=>{o.d(t,{A:()=>r});let r=(0,o(1713).A)("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]])},1713:(e,t,o)=>{o.d(t,{A:()=>i});var r=o(4232);let a=e=>{let t=e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,o)=>o?o.toUpperCase():t.toLowerCase());return t.charAt(0).toUpperCase()+t.slice(1)},n=function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];return t.filter((e,t,o)=>!!e&&""!==e.trim()&&o.indexOf(e)===t).join(" ").trim()};var s={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let c=(0,r.forwardRef)((e,t)=>{let{color:o="currentColor",size:a=24,strokeWidth:c=2,absoluteStrokeWidth:i,className:l="",children:d,iconNode:g,...u}=e;return(0,r.createElement)("svg",{ref:t,...s,width:a,height:a,stroke:o,strokeWidth:i?24*Number(c)/Number(a):c,className:n("lucide",l),...!d&&!(e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0})(u)&&{"aria-hidden":"true"},...u},[...g.map(e=>{let[t,o]=e;return(0,r.createElement)(t,o)}),...Array.isArray(d)?d:[d]])}),i=(e,t)=>{let o=(0,r.forwardRef)((o,s)=>{let{className:i,...l}=o;return(0,r.createElement)(c,{ref:s,iconNode:t,className:n("lucide-".concat(a(e).replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()),"lucide-".concat(e),i),...l})});return o.displayName=a(e),o}},6143:(e,t,o)=>{o.d(t,{A:()=>d});var r=o(4232),a=o(9099),n=o(2491),s=o.n(n),c=o(7431),i=o(6460),l=o(8581);function d(e,t,o){var n;let d=(0,a.useRouter)(),{customerId:g}=d.query,u=(0,r.useRef)(!1),h=(0,r.useRef)(!1),m=(0,r.useRef)([]);(0,r.useRef)(!1),(0,r.useRef)(!1);let f=(0,r.useRef)(!1),[p,w]=(0,r.useState)([]),[S,_]=(0,r.useState)(""),[v,y]=(0,r.useState)(0),[k,I]=(0,r.useState)(0),b=JSON.parse(localStorage.getItem("user")||"{}"),A=null==b||null==(n=b.user)?void 0:n.id,C="astrologer"===t?g:null==e?void 0:e.id,[M,j]=(0,r.useState)(()=>{{let e=localStorage.getItem("ongoing_chat");if(e)try{let t=JSON.parse(e);if(t.timestamp)return new Date(t.timestamp)}catch(e){console.warn("Invalid chat timestamp in localStorage")}}return new Date});(0,r.useEffect)(()=>{A&&C&&"customer"===t&&localStorage.setItem("ongoing_chat",JSON.stringify({astrologer:e,timestamp:M.toISOString()}))},[A,C,M]),(0,r.useEffect)(()=>{if(!A||!C)return;let e=async()=>{try{let e=await (0,l.W)("".concat(i.v.base_url,"chat/messages?senderId=").concat(A,"&receiverId=").concat(C),{headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(localStorage.getItem("token"))}}),t=await e.json();console.log("result",t),(null==t?void 0:t.status)&&Array.isArray(t.data)&&(console.log("result"),window.socket.on("initialMessages",e=>{let t=e.map(e=>({...e,isSent:e.sender_id===A,isImage:!0===e.isImage||/\.(jpeg|jpg|gif|png|webp)$/i.test(e.message)}));w(e=>{let o=[...e,...t];return localStorage.setItem("chat_messages",JSON.stringify(o)),o})}))}catch(e){console.error("Error fetching chat history:",e)}};localStorage.getItem("chat_messages")||e(),"astrologer"===t&&g&&(T(g),R())},[A,C,t,g]),(0,r.useEffect)(()=>{let e=localStorage.getItem("chat_messages");if(e)try{let t=JSON.parse(e);w(t)}catch(e){console.error("Error parsing cached chat messages:",e)}},[]),(0,r.useEffect)(()=>{"customer"===t&&A&&(async()=>{try{var e;let t=await (0,l.W)("".concat(i.v.base_url,"payment/").concat(A),{headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))}}),o=await t.json();y((null==(e=o.data)?void 0:e.amount)||0)}catch(e){console.error("Error fetching balance:",e)}})()},[t,A]),(0,r.useEffect)(()=>{"customer"===t&&(null==e?void 0:e.chat_charge)&&v>0&&M&&I(Math.max(Math.floor(v/e.chat_charge*60)-Math.floor((new Date().getTime()-M.getTime())/1e3),0))},[null==e?void 0:e.chat_charge,v,t,M]),(0,r.useEffect)(()=>{if(k<=0)return;let e=setInterval(()=>{I(t=>t<=1?(clearInterval(e),u.current||(u.current=!0,o()),0):t-1)},1e3);return()=>clearInterval(e)},[k]);let E=e=>{var o;console.log("\uD83D\uDCE9 Incoming message:",e);let r=e.sender_id===A,a={...e,isSent:r,isImage:!0===e.isImage||/\.(jpeg|jpg|gif|png|webp)$/i.test(e.message)};w(e=>{let t=[...e,a];return localStorage.setItem("chat_messages",JSON.stringify(t)),t}),r||(T(e.sender_id),R()),!f.current&&(null==(o=e.message)?void 0:o.includes("Welcome"))&&"customer"===t&&(f.current=!0)},N=async function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=Math.floor((new Date-M)/1e3);if(o<20&&h.current&&!t)return void s().fire("You can end the chat only after 1 minute.","","info");if(u.current)return;if(u.current=!0,localStorage.removeItem("ongoing_chat"),!e)return void console.error("Missing astrologer data while ending chat.");let r=e.chat_charge||5,a=Math.min(o/60,v/r),n=parseFloat((a*r).toFixed(2)),g=localStorage.getItem("token"),m={user_id:String(A),astrologer_id:String(e.id),chat_id:String(e.id),duration_minutes:a,total_charge:n};try{var f;let o=await (0,l.W)("".concat(i.v.base_url,"chat/chat_transation"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(g)},body:JSON.stringify(m)}),r=await o.json();if(!o.ok||!(null==r?void 0:r.status))return void s().fire("Failed to save chat transaction","","error");let a=await (0,l.W)("".concat(i.v.base_url,"payment/update-balance/").concat(A),{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(g)},body:JSON.stringify({amount:n})}),u=await a.json();a.ok&&(null==u?void 0:u.status)||s().fire("Chat saved, but balance update failed","","warning"),(null==(f=window)?void 0:f.socket)&&window.socket.emit("end_chat_by_customer",{senderId:A,receiverId:e.id,roomId:"".concat((0,c.$d)(A,e.id))}),s().fire("Chat ended","","success").then(()=>{localStorage.removeItem("chat_messages"),d.push(t?"/wallet-recharge":"/astrologer")})}catch(e){console.error("Transaction failed",e),s().fire("Something went wrong","","error")}};(0,r.useEffect)(()=>{let e;if(!A||!C)return;let o=(0,c.$d)(A,C);return(0,c.b0)(A,C).then(()=>{e=(0,c.SR)(E),console.log(" 1 initialMessages:"),window.socket.on("initialMessages",e=>{console.log(" 2 initialMessages:"),console.log("\uD83D\uDCE5 Received initialMessages on frontend:",e);let t=e.map(e=>({...e,isSent:e.sender_id===A,time:x(new Date)}));w(e=>[...t,...e]),localStorage.setItem("chat_messages",JSON.stringify(t))}),console.log("➡️ Emitting join_room:",o),window.socket.emit("join_room",o);let r=localStorage.getItem("chat_messages"),a=!r||0===JSON.parse(r).length;"customer"===t&&a&&(window.socket.on("chat_accepted",e=>{let{receiverId:t}=e;return d.push("/chat/".concat(t))}),window.socket.on("chat_rejected",()=>s().fire("Sorry!","Astrologer rejected the request.","info"))),"astrologer"===t&&(window.socket.on("request_chat",e=>{m.current.push(e)}),window.socket.on("chat_ended_by_customer",()=>{localStorage.removeItem("chat_messages"),localStorage.removeItem("ongoing_chat"),s().fire("Chat ended","The customer has ended the chat.","info").then(()=>{let e=m.current.shift();e&&window.socket.emit("accept_chat",{senderId:e.senderId,receiverId:e.receiverId,roomId:e.roomId}),d.push("/vendor-requests")})}))}).catch(e=>console.error("Socket init failed",e)),()=>{null==e||e(),window.socket.off("initialMessages"),(0,c.G1)()}},[null==e?void 0:e.id,t,g,A,C]);let T=async e=>{try{let t=localStorage.getItem("token");await (0,l.W)("".concat(i.v.base_url,"chat/mark-read/").concat(e),{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)}})}catch(e){console.error("❌ Failed to mark messages as read",e)}},R=async()=>{try{var e;let t=localStorage.getItem("token"),o=null==b||null==(e=b.user)?void 0:e.id;await (0,l.W)("".concat(i.v.base_url,"chat/unread-count/").concat(o),{headers:{Authorization:"Bearer ".concat(t)}})}catch(e){console.error("❌ Failed to fetch unread count",e)}},x=e=>{let t=String(Math.floor(e/60)).padStart(2,"0"),o=String(e%60).padStart(2,"0");return"".concat(t,":").concat(o)};return{messages:p,input:S,setInput:_,setMessages:w,sendMessage:()=>{if(!S.trim())return;let o=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),r="astrologer"===t?g:null==e?void 0:e.id;_(""),(0,c._z)({message:S,time:o,isSent:!0,sender_id:A,receiver_id:r})},sendImageMessage:o=>{let r=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a="astrologer"===t?g:null==e?void 0:e.id;(0,c._z)({message:o,time:r,isSent:!0,isImage:!0,sender_id:A,receiver_id:a})},remainingTime:k,formatTime:x,handleEndChat:N,setEndClicked:()=>h.current=!0}}},7163:(e,t,o)=>{o.d(t,{A:()=>r});let r=(0,o(1713).A)("smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]])},7431:(e,t,o)=>{o.d(t,{$d:()=>n,G1:()=>g,SR:()=>i,_z:()=>c,b0:()=>s,mb:()=>l,pY:()=>d});var r=o(2692);let a=null,n=(e,t)=>[e,t].sort().join("-"),s=(e,t)=>{let o=n(e,t);return console.log("\uD83D\uDFE1 [initiateSocket] userId:",e,"receiverId:",t,"roomId:",o),new Promise(t=>{a||(a=(0,r.io)("http://www.astrobolo.com",{transports:["websocket"],query:{userId:e},withCredentials:!0}),window.socket=a),a.on("connect",()=>{console.log("✅ [Socket Connected] ID:",a.id),a.emit("join_room",o),console.log("\uD83D\uDCE9 [Join Room] roomId:",o),t(a)}),a.on("disconnect",()=>{console.log("\uD83D\uDD34 [Socket Disconnected]")})})},c=e=>{if(!a)return void console.log("❌ [sendMessage] Socket not initialized.");let t=n(e.sender_id,e.receiver_id);console.log("\uD83D\uDCE4 [sendMessage] Emitting to room:",t,"Message:",e),a.emit("sendMessage",{message:e,roomId:t})},i=e=>{if(!a)return;let t=t=>{console.log("\uD83D\uDCEC [subscribeToMessages] Received message:",t),e(t)};return a.on("receiveMessage",t),()=>{a.off("receiveMessage",t)}},l=e=>{if(!a)return;let t=t=>{console.log("\uD83D\uDCE8 [subscribeToChatRequests] Incoming:",t),e(t)};return a.on("request_chat",t),()=>{a.off("request_chat",t)}},d=e=>{if(console.log(" under subscribeToChatAccepted function in socket"),!a)return;let t=t=>{console.log("✅ [subscribeToChatAccepted] Chat accepted by astrologer:",t),e(t)};return a.on("chat_accepted",t),console.log("socket chat accepted 1"),()=>{console.log("socket chat accepted 2"),a.off("chat_accepted",t)}},g=()=>{a&&(console.log("\uD83D\uDD0C [disconnectSocket] Disconnecting..."),a.disconnect(),a=null)}}}]);